## Codebase Patterns
- Project uses FastAPI with Python 3.12, async SQLAlchemy, Redis
- All config via pydantic-settings with env vars
- Use structlog for JSON logging
- Docker-compose has postgres (PostGIS), Redis, API services
- All API responses must include data_quality object
- REST endpoints under /v1/ prefix
- File naming: snake_case.py for Python
- Type annotations required on all functions
- Google-style docstrings
- Runtime is Python 3.10 (not 3.12) — use `from __future__ import annotations` for newer type syntax
- Redis class is not generic at runtime in this redis version — use `# type: ignore[type-arg]` or `from __future__ import annotations`
- `postal` library requires libpostal C library — commented out in requirements.txt
- Middleware/auth/rate-limit must handle Redis unavailability gracefully (try/except) for tests and degraded mode
- Lifecycle startup should warn (not crash) when DB/Redis unavailable
- ruff config ignores B008 (Depends in defaults) and PLR2004 (magic numbers in tests)
- pyproject.toml in api/ configures ruff, mypy, and pytest
- Run quality checks from api/ directory: `python3 -m ruff check app/ tests/`, `python3 -m mypy app/`, `python3 -m pytest tests/ -v`
- Use `from __future__ import annotations` + `TYPE_CHECKING` block for forward references in models
- All model tables live in `parcel` schema — set via `__table_args__`
- Composite indexes go in `__table_args__` tuple, simple column indexes use `index=True` on `mapped_column`
- Alembic `env.py` must `import app.models` to register models with `Base.metadata`
- Exclude `alembic/` from both ruff and mypy (auto-generated migration style)
- geoalchemy2/pgvector mypy ignores are handled in pyproject.toml `[[tool.mypy.overrides]]`
- Stripe library has typed stubs — no `type: ignore[import-untyped]` needed but some methods need `type: ignore[attr-defined]` or `type: ignore[no-untyped-call]`
- When using Redis `hset` with strict mypy, annotate mapping as `dict[str | bytes, bytes | float | int | str]`
- Public endpoints (signup, webhooks) must be added to `PUBLIC_PATHS` or `PUBLIC_PREFIXES` in auth middleware
- PLC0415: ruff requires all imports at module top level — don't use local imports inside methods
- MCP server: `npm install --include=dev` needed for devDependencies (@types/node, vitest, etc.)
- MCP SDK v1.26.0: `types: ["node"]` in tsconfig.json for Node.js globals (process, console, fetch)
- MCP tool handlers accept `Record<string, unknown> | undefined` — cast to typed interface with all-optional fields
- MCP server quality checks from mcp/ dir: `npx tsc --noEmit`, `npx eslint src/`, `npx vitest run`
- SDK quality checks from sdk/ dir: `python3 -m ruff check parceldata/ tests/`, `python3 -m mypy parceldata/`, `python3 -m pytest tests/ -v`
- SDK uses `pip install -e ".[dev]"` for editable install with dev dependencies
- `concurrent.futures.Future` needs type annotation: `Future[object]` for strict mypy
- Agent-readable endpoints (/llms.txt, /.well-known/ai-plugin.json, /jsonld) must be in PUBLIC_PATHS
- Docs URLs changed from /docs to /v1/docs and /v1/redoc — update PUBLIC_PREFIXES accordingly
- Landing page (site/): Static HTML with Tailwind CDN, no build step. Inline SVG icons, CSS-only animations. No external JS dependencies.

---

## 2026-02-18 - S1-S14 (API Foundation)
- Implemented all 14 code stories for P10-01 API Foundation
- Files created:
  - api/app/config.py (S2: Pydantic Settings)
  - api/app/logging_config.py (S9: structlog setup)
  - api/app/database/__init__.py, connection.py, redis.py (S3, S4: DB + Redis)
  - api/app/lifecycle.py (S12: startup/shutdown)
  - api/app/middleware/__init__.py, error_handler.py, authentication.py, rate_limit.py (S6-S8, S13)
  - api/app/routes/__init__.py, health.py, properties.py, analytics.py, auth.py (S5, S14)
  - api/app/main.py (S1, S10: FastAPI app + CORS)
  - api/alembic/ (S11: migration framework)
  - api/pyproject.toml (tool config)
  - api/tests/conftest.py, test_health.py (4 tests)
- Files modified:
  - api/requirements.txt (commented out postal)
- **Learnings for future iterations:**
  - Python runtime is 3.10, not 3.12 — use `from __future__ import annotations` for union syntax
  - Redis[Any] type annotation crashes at runtime — need `from __future__ import annotations` or `# type: ignore`
  - postal lib needs libpostal C headers — not available in this env
  - Auth/rate-limit middleware must gracefully handle Redis being unavailable
  - Lifecycle startup should warn, not crash, when services are down
  - BaseHTTPMiddleware dispatch must accept `RequestResponseEndpoint` type for call_next
---

## 2026-02-18 - S15 (Docker Build Verification)
- Docker image `parceldata-api` builds successfully from api/Dockerfile
- PostgreSQL port 5432 may conflict with host postgres — use different port mapping if needed
- docker-compose.yml `version` attribute is deprecated (warning only)
- **Learnings for future iterations:**
  - Docker build works with Python 3.12-slim base image
  - Port conflicts are environment-specific; the build itself is valid
  - Add .dockerignore to api/ to speed up builds (exclude __pycache__, .git, etc.)
---

## 2026-02-18 - S1-S15 (P10-02 Data Models)
- Implemented all 15 stories for P10-02 Data Models
- Files created:
  - api/app/models/base.py (S1: TimestampMixin, DataQualityMixin, ProvenanceMixin)
  - api/app/models/property.py (S2: core Property with PostGIS + pgvector)
  - api/app/models/address.py (S3: normalized addresses)
  - api/app/models/building.py (S4: building structures)
  - api/app/models/valuation.py (S5: assessed + estimated values)
  - api/app/models/ownership.py (S6: owner info)
  - api/app/models/zoning.py (S7: zoning restrictions, ARRAY + JSONB columns)
  - api/app/models/listing.py (S8: MLS listings)
  - api/app/models/transaction.py (S9: deed transfers)
  - api/app/models/permit.py (S10: building permits)
  - api/app/models/environmental.py (S11: hazards and risk)
  - api/app/models/school.py (S12: school assignments)
  - api/app/models/tax.py (S13: property taxes)
  - api/app/models/hoa.py (S13: HOA data)
  - api/app/models/__init__.py (S14: package exports)
  - api/alembic/versions/001_initial_schema.py (S15: migration)
  - api/tests/test_models_base.py (4 tests)
  - api/tests/test_models.py (60 tests)
  - api/tests/test_migration.py (5 tests)
- Files modified:
  - api/alembic/env.py (import all models for autogenerate)
  - api/pyproject.toml (exclude alembic/ from ruff)
- **Learnings for future iterations:**
  - Forward references in SQLAlchemy models: use `TYPE_CHECKING` block for imports + string names in `relationship()`
  - geoalchemy2 Geometry and pgvector Vector columns: use `Mapped[object | None]` type hint (not Mapped[Geometry])
  - str(ForeignKey.column) returns table.column without schema prefix — don't test for schema prefix
  - Migration files split into helper functions to avoid PLR0915 (>50 statements)
  - `alembic.versions.xxx` is not directly importable as a Python module — use `importlib.util.spec_from_file_location`
  - All 13 models: Property, Address, Building, Valuation, Ownership, Zoning, Listing, Transaction, Permit, Environmental, School, Tax, HOA
---

## 2026-02-18 - S1-S15 (P10-03 Core API)
- Implemented all 15 stories for P10-03 Core API
- Files created:
  - api/app/schemas/__init__.py, property.py (S1: 16 Pydantic response schemas)
  - api/app/schemas/search.py (S5: SearchRequest/SearchResponse, BatchLookup)
  - api/app/schemas/analytics.py (S7: ComparableProperty, ComparablesResponse, MarketTrendsResponse)
  - api/app/services/property_service.py (S2: lookup by ID/address/coords, model-to-schema conversion)
  - api/app/services/search_service.py (S4: SearchFilters, dynamic query building with conditional joins)
  - api/app/services/comparables_service.py (S6: comparable sales with similarity scoring)
  - api/app/graphql/__init__.py, schema.py (S10: Strawberry GraphQL types + Query resolver)
  - api/app/utils/__init__.py, pagination.py (S13: CursorPage, encode/decode cursor)
  - api/tests/test_schemas.py (24 tests), test_property_service.py (9 tests)
  - api/tests/test_comparables_service.py (6 tests), test_pagination.py (7 tests)
  - api/tests/test_properties.py (14 integration tests including data_quality checks)
- Files modified:
  - api/app/routes/properties.py (S3, S5, S8, S9: lookup, search, batch, field selection)
  - api/app/routes/analytics.py (S7: comparables and market trends endpoints)
  - api/app/main.py (S11, S12, S15: GraphQL mount, OpenAPI docs, exception handlers with data_quality)
  - api/app/middleware/error_handler.py (S15: data_quality in error responses)
  - api/app/middleware/authentication.py (S15: data_quality in 401 responses)
  - api/app/middleware/rate_limit.py (S15: data_quality in 429 responses)
  - api/pyproject.toml (added PLR0912, PLR0915 to ruff ignores)
  - api/tests/test_health.py (updated assertions for route changes)
- Key patterns:
  - `ExecutableOption` from `sqlalchemy.sql.base` for typing selectinload lists
  - `ColumnElement[bool]` from sqlalchemy for typing dynamic WHERE conditions
  - Token-optimized response tiers: micro/standard/extended/full via `?detail=` param
  - Field selection via `?select=` always preserves data_quality
  - All error responses (401, 404, 422, 429, 500) include data_quality object
  - SearchResponse and BatchLookupResponse compute aggregate data_quality
  - Strawberry GraphQL resolves properties with DataQualityType
- 129 total tests passing
- **Learnings for future iterations:**
  - Middleware JSONResponse returns bypass FastAPI exception handlers — must add data_quality manually
  - Route order matters in FastAPI: /{property_id} must come after /search, /batch, /address/lookup, /coordinates/lookup
  - Integration tests without DB: accept both expected status and 500 (connection refused)
  - `SearchResponse.data_quality` is aggregate of individual result scores
---

## 2026-02-18 - S1-S12 (P10-04 Auth & Billing)
- Implemented all 12 stories for P10-04 Auth & Billing
- Files created:
  - api/app/models/api_key.py (S1: Account + APIKey + TierEnum models)
  - api/app/models/usage.py (S2: UsageRecord + UsageEvent models)
  - api/app/services/auth_service.py (S3: key creation, validation, revocation, Redis caching)
  - api/app/services/usage_service.py (S4: usage recording, daily aggregation, quota checks)
  - api/app/services/stripe_service.py (S7: Stripe customer, checkout, portal, subscription mgmt)
  - api/app/routes/account.py (S6: usage summary, billing info, upgrade endpoints)
  - api/app/routes/webhooks.py (S8: Stripe webhook handler with event dispatching)
  - api/app/middleware/usage_tracking.py (S9: automatic usage metering for /v1/ requests)
  - api/alembic/versions/002_auth_and_usage_tables.py (S12: migration for 4 new tables)
  - api/tests/test_auth_models.py (25 tests for S1-S2)
  - api/tests/test_auth_service.py (13 tests for S3)
  - api/tests/test_usage_service.py (15 tests for S4)
  - api/tests/test_auth_routes.py (9 tests for S5)
  - api/tests/test_account_routes.py (10 tests for S6)
  - api/tests/test_stripe_service.py (14 tests for S7 + S11)
  - api/tests/test_webhooks.py (4 tests for S8)
  - api/tests/test_usage_tracking.py (4 tests for S9)
  - api/tests/test_rate_limit_enhanced.py (9 tests for S10)
- Files modified:
  - api/app/models/__init__.py (added Account, APIKey, TierEnum, UsageEvent, UsageRecord exports)
  - api/app/routes/auth.py (S5: rewrote with signup, create key, list keys, revoke key)
  - api/app/middleware/authentication.py (S5: added /v1/auth/signup and /webhooks to public paths)
  - api/app/middleware/rate_limit.py (S10: added monthly quota checks, X-Usage-* headers)
  - api/app/middleware/__init__.py (S9: export UsageTrackingMiddleware)
  - api/app/main.py (S6/S8/S9: registered account_router, webhooks_router, UsageTrackingMiddleware)
  - api/app/config.py (S11: added 5 Stripe settings)
  - api/requirements.txt (S7: added stripe>=7.0.0)
  - api/pyproject.toml (S7: added stripe.* to mypy overrides)
  - api/tests/test_migration.py (S12: updated for auth tables + 2 new tests)
- Key patterns:
  - API key hashed with SHA-256 before storage; raw key shown once at creation
  - Redis cache for key validation with DB fallback
  - Usage tracking: Redis counter for fast quota checks, DB for durable aggregates
  - Four tiers: free (3K/mo), pro (50K/mo), business (500K/mo), enterprise (10M/mo)
  - Stripe webhook handler with event routing (checkout, subscription, payment)
  - All new middleware handles Redis/DB unavailability gracefully
- 234 total tests passing (105 new)
- **Learnings for future iterations:**
  - Stripe typed stubs are strict — `Webhook.construct_event` needs `type: ignore[no-untyped-call]`
  - `SubscriptionItem.create_usage_record` needs `type: ignore[attr-defined]` in current stripe version
  - Redis hset mapping type: annotate as `dict[str | bytes, bytes | float | int | str]` for strict mypy
  - PLC0415 ruff rule: all imports must be at top of file, not inside methods
  - Middleware stack order matters: UsageTracking innermost → RateLimit → Auth → ErrorHandler outermost
  - /v1/auth/signup must be in PUBLIC_PATHS for unauthenticated access
  - /webhooks must be in PUBLIC_PREFIXES for Stripe callbacks
---

## 2026-02-18 - S1-S12 (P10-05 Data Pipeline)
- Implemented all 12 stories for P10-05 Data Pipeline
- Files created:
  - api/app/services/ingestion/__init__.py (package init)
  - api/app/services/ingestion/base.py (S1: ProviderAdapter ABC + RawPropertyRecord)
  - api/app/services/ingestion/providers/__init__.py (S12: package exports for all 4 adapters)
  - api/app/services/ingestion/providers/regrid.py (S2: Regrid parcel data adapter)
  - api/app/services/ingestion/providers/attom.py (S3: ATTOM property data adapter)
  - api/app/services/ingestion/providers/census.py (S4: Census ACS demographics adapter)
  - api/app/services/ingestion/providers/fema.py (S5: FEMA flood zone adapter)
  - api/app/services/address.py (S6: USPS address normalization with usaddress)
  - api/app/services/geocoding.py (S7: Multi-provider geocoding with Census/Nominatim fallback)
  - api/app/services/entity_resolution.py (S8: Cross-source property deduplication)
  - api/app/services/quality.py (S9: Data quality scoring with 6 components)
  - api/app/services/ingestion/pipeline.py (S10: ETL pipeline with ProcessedRecord)
  - api/app/cli/__init__.py (S11: CLI package init)
  - api/app/cli/import_data.py (S11: Batch import CLI with PROVIDERS dict)
  - api/tests/test_ingestion_base.py (15 tests)
  - api/tests/test_regrid_adapter.py (15 tests)
  - api/tests/test_attom_adapter.py (13 tests)
  - api/tests/test_census_adapter.py (13 tests)
  - api/tests/test_fema_adapter.py (12 tests)
  - api/tests/test_address_service.py (18 tests)
  - api/tests/test_geocoding_service.py (13 tests)
  - api/tests/test_entity_resolution.py (24 tests)
  - api/tests/test_quality_service.py (33 tests)
  - api/tests/test_ingestion_pipeline.py (16 tests)
  - api/tests/test_import_cli.py (12 tests)
  - api/tests/test_provider_package.py (21 tests)
- Files modified:
  - api/pyproject.toml (added PLR0911 to ruff ignores, jellyfish.* to mypy overrides)
  - api/requirements.txt (added jellyfish>=1.0.0)
- 439 total tests passing (205 new)
- **Learnings for future iterations:**
  - Use `collections.abc.AsyncIterator` not `typing.AsyncIterator` — ruff UP035 rule
  - Abstract base `stream_region` must be `def` not `async def` — subclass async generators return `AsyncIterator` directly
  - httpx `response.json()` is sync — use `MagicMock` for response, `AsyncMock` for `client.get`
  - `zip()` needs `strict=` parameter — ruff B905 rule, use `strict=False`
  - When testing code that looks up from a module-level dict (e.g., `PROVIDERS`), use `patch.dict()` not `patch()` on the class
  - `jellyfish` library for Jaro-Winkler similarity — needs mypy override
  - Data quality scoring: empty data gets ~0.62 score (accuracy=0.8 default, consistency=0.85 default)
  - Float arithmetic: 0.2+0.3+0.2+0.2+0.1 != 1.0 exactly — use `pytest.approx()`
---

## 2026-02-18 - S1-S10 (P10-06 MCP Server)
- Implemented all 10 stories for P10-06 MCP Server
- Files created:
  - mcp/src/index.ts (S1: Server entry point with stdio transport, tool routing via handler map)
  - mcp/src/tools/definitions.ts (S2: All 9 tool schemas with JSON Schema inputSchema)
  - mcp/src/client/api.ts (S3: API client with GET/POST, query params, auth headers, error handling)
  - mcp/src/tools/property-lookup.ts (S4: Lookup by address, parcel_id, or lat/lng)
  - mcp/src/tools/property-search.ts (S5: POST search with filters)
  - mcp/src/tools/get-comparables.ts (S6: Comparable sales with address-to-ID lookup)
  - mcp/src/tools/get-market-trends.ts (S7: Area market statistics)
  - mcp/src/tools/check-zoning.ts (S8: Permitted/conditional/prohibited use check)
  - mcp/src/tools/get-permits.ts (S9: Permit history with status/type/date filters)
  - mcp/src/tools/get-owner-portfolio.ts (S10: Owner portfolio lookup)
  - mcp/src/tools/estimate-value.ts (S10: Automated valuation with adjustments)
  - mcp/src/tools/check-development-feasibility.ts (S10: Max buildable area from zoning)
  - mcp/test/index.test.ts (4 tests)
  - mcp/test/definitions.test.ts (15 tests)
  - mcp/test/api-client.test.ts (8 tests)
  - mcp/test/tools.test.ts (25 tests)
  - mcp/.eslintrc.json, .prettierrc.json, vitest.config.ts (tooling config)
- Files modified:
  - mcp/tsconfig.json (added `types: ["node"]` for Node.js globals)
  - prd.json (updated for P10-06)
- 52 tests passing (TypeScript strict, ESLint clean)
- **Learnings for future iterations:**
  - MCP SDK v1.26.0 uses Zod schemas for request validation (ListToolsRequestSchema, CallToolRequestSchema)
  - `lib: ["ES2022"]` alone doesn't provide `process`, `console`, `fetch` — add `types: ["node"]` to tsconfig
  - MCP tool handlers receive `Record<string, unknown> | undefined` from the SDK — use interface with all-optional fields to avoid TS cast errors
  - `npm install` without `--include=dev` skips devDependencies — need `--include=dev` for @types/node, vitest, etc.
  - Use `type: "text" as const` for MCP content blocks to satisfy TypeScript literal types
  - createServer() factory function is testable without stdio transport
  - Tool handler map (`Record<string, ToolHandler>`) is cleaner than switch/case for routing
---

## 2026-02-18 - S1-S10 (P10-07 Python SDK & Documentation)
- Implemented all 10 stories for P10-07 SDK & Documentation
- Files created:
  - sdk/parceldata/__init__.py (S1: package exports with version)
  - sdk/parceldata/client.py (S2: ParcelDataClient with async/sync methods, retry, rate limit handling)
  - sdk/parceldata/models.py (S3: 20 Pydantic models matching API responses)
  - sdk/parceldata/exceptions.py (S4: 6 exception classes with status codes)
  - sdk/parceldata/types.py (S1: type definitions — DetailTier, SortOrder, Confidence)
  - sdk/parceldata/utils.py (S1: run_sync, build_query_params, retry_delays)
  - sdk/pyproject.toml (S1: ruff, mypy, pytest config for SDK)
  - sdk/LICENSE (S1: MIT license)
  - sdk/tests/conftest.py (S5: fixtures with sample API response data)
  - sdk/tests/test_client.py (S5: 10 tests — init, lookup, search, batch, errors, retry, context manager)
  - sdk/tests/test_models.py (S5: 10 tests — all model types, serialization)
  - api/app/openapi_config.py (S6: enhanced OpenAPI tags, response examples)
  - api/app/routes/agent_readable.py (S7/S8: /llms.txt, /.well-known/ai-plugin.json, /jsonld endpoints)
  - api/app/middleware/jsonld.py (S9: Organization, WebAPI, DataCatalog JSON-LD schemas)
  - api/tests/test_agent_readable.py (S7/S8: 6 tests for agent endpoints)
  - api/tests/test_jsonld.py (S9: 7 tests for JSON-LD schemas and endpoint)
  - docs/QUICKSTART.md (S10: install, auth, lookup, search, batch, MCP setup)
  - docs/API_REFERENCE.md (S10: all endpoints with curl examples, error codes, rate limits)
- Files modified:
  - api/app/main.py (S6: enhanced OpenAPI config with tags, license, contact, servers)
  - api/app/middleware/authentication.py (S7/S8/S9: added agent-readable paths to PUBLIC_PATHS)
  - api/tests/test_properties.py (S6: updated OpenAPI title/version assertions)
  - README.md (S10: updated quick start with SDK usage, MCP config, architecture)
- 452 API tests + 20 SDK tests + 52 MCP tests = 524 total tests passing
- **Learnings for future iterations:**
  - SDK `concurrent.futures.Future` needs explicit type annotation for strict mypy
  - ruff checks long lines even inside multi-line strings (LLMS_TXT) — keep under 88 chars
  - Agent-readable paths (/llms.txt, /.well-known/*, /jsonld) must be in PUBLIC_PATHS for unauthenticated access
  - Docs URL changed to /v1/docs and /v1/redoc — update PUBLIC_PREFIXES tuple
  - `pip install -e ".[dev]"` for SDK editable install with dev extras
  - run_sync helper: use ThreadPoolExecutor when event loop is already running (for sync wrappers in async context)
---

## 2026-02-18 - S1-S12 (P10-08 Landing Page)
- Implemented all 12 stories for P10-08 Landing Page
- Files created:
  - site/index.html (S1-S9, S12: Full landing page with all sections)
  - site/llms.txt (S10: Agent-readable plain text summary)
  - site/.well-known/ai-plugin.json (S11: OpenAI plugin manifest)
- Template adaptation:
  - Copied CSS patterns from /home/numen/dharma/templates/aura-finance/
  - Kept: Tailwind CSS CDN, Inter+Newsreader fonts, spotlight cards, shiny CTA, beam animations, grid background, dark theme
  - Removed: UnicornStudio dependency, external images, Aura branding
  - Added: Code syntax highlighting, tab switcher, pricing toggle, data source marquee
- Sections implemented:
  - Navigation: Pill nav with Docs, Pricing, GitHub, API Reference links + "Get API Key" CTA
  - Hero: Status pill ("Open Source · MIT Licensed"), headline, subheadline, code preview
  - Feature Cards: Property Intelligence (JSON preview), MCP Native (connection diagram), Entity Resolution (quality score bars)
  - Code Examples: Tab-based switcher (Python, curl, TypeScript, GraphQL)
  - Pricing: Free/$0, Pro/$49, Scale/Custom with monthly/annual toggle (-20%)
  - Data Coverage: Stats (150M+, 50 states, 20+ sources, 13 categories) + data source marquee
  - Agent Readability: 4 cards (/llms.txt, MCP Tools, Token-Optimized, JSON-LD)
  - Footer: Brand, product links, legal, social icons (GitHub/X/Discord), install snippets
  - SEO: Title, JSON-LD SoftwareApplication structured data
- **Learnings for future iterations:**
  - All sections fit naturally in a single HTML file with Tailwind CDN — no build step needed
  - Spotlight card effect requires JS mousemove listener setting CSS custom properties
  - Tab switcher: toggle hidden class + update tab-active/tab-inactive classes
  - Pricing toggle: use separate .price-monthly/.price-annual elements toggled with JS
  - Data source marquee: duplicate items for seamless loop, use mask-gradient-fade for edge fading
  - SVG icons inline (Lucide-style) avoid external dependencies
  - JSON-LD structured data in <script type="application/ld+json"> at page bottom
---
